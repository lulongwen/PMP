# SaaS问题

* SaaS1000问


我们的体会，核心是平衡。需要面对很多矛盾点，逻辑性思考，建立快速试错和纠正的机制，寻找出一系列的平衡规则。
  1. 多租户的模式，安全，效率（开发、运维等），之间的平衡。
  2. 简单易用和功能强大之间，功能合理的平衡。
  3. issue和新功能效率，与产品稳定之间的平衡。
  4. 客服效率和精准反馈之间平衡。
  5. 服务器架构、稳定访问、访问速度之间的平衡。
  6. 模块层解决方案的平衡：功能的高覆盖、功能配置性、使用复杂度、使用效率、扩展集成性等之间的平衡。
  7  最后是架构抽象化，提供强的移植和扩展的保障。
总之，SaaS需要考虑的细节要比单一产品复杂的多，很多不试错是不会有体会的。当然也和产品的目标对象和用途有很大关系，之所以罗列这么多，也是和我们是面向企业的平台应用有关。欢迎交流。

项目介绍
一个类ERP的系统，包括工单流程模块，采购模块，库存模块，和会员管理模块等，面向广大社会修理厂的 to B 的 Saas产品；类似现在的钉钉
Saas 产品技术于传统技术的重要差别是？
Saas多租户数据隔离、存储的方案有几种，比较优劣？
多租户，不同租户多角色，各角色对应不同模块多权限可配置管理设计方案，怎么处理权限分配?
有几种权限分配模型?  3中流行的权限模型
Saas系统租户的识别方案
Saas系统的安全性设计，一般常见的安全性设计分为哪2类？
系统级 & 程序级
客户端输入校验，防止JS攻击，XSS攻击，SQL攻击

Saas 产品多租户应用可配置包括哪些方面？
Saas系统的高性能优化有哪几方面？
怎么处理日志问题?有那些可行的方案?
对于大表数据的处理?
当系统用户越来越多，数据量级也快速增长，单数据库无法满足需求的时候，如何处理？
Saas 系统的高性能优化有哪几方面？
Saas系统的灰度升级方案及原理？
当客户反映，程序变的很慢的时候，你是怎么处理这个问题的？
a.数据库端.b.后端应用平台端.c.前端web端.d.负载均衡.e.网络设置.f.机器性能的优化.g.考虑是否有病毒、木马等干扰等等

比如1台后端服务，支撑10个前端应用，怎么做到不重启服务?能够分别支持10个前端应用，有自己的业务逻辑?
有自己的业务逻辑表现为：代码的执行不一样。 也就是怎么做到不重启服务，是代码的执行不一样.

怎么做到系统整合
1. 通过代码的整合方式，使用相同的数据库。
2. 通过SSO方式，可以是异构数据库.

二 SQL
SQL优化
1.对查询进行优化，应尽量避免全表扫描，首先应考虑在 where 及 order by 涉及的列上建立索引。   
    
2.应尽量避免在 where 子句中对字段进行 null 值判断，否则将导致引擎放弃使用索引而进行全表扫描，如：    
select id from t where num is null  
可以在num上设置默认值0，确保表中num列没有null值，然后这样查询：   
select id from t where num=0    
    
3.应尽量避免在 where 子句中使用!=或<>操作符，否则将引擎放弃使用索引而进行全表扫描。  
    
4.应尽量避免在 where 子句中使用 or 来连接条件，否则将导致引擎放弃使用索引而进行全表扫描，如：   
select id from t where num=10 or num=20 
可以这样查询： 
select id from t where num=10   
union all   
select id from t where num=20   
    
5.in 和 not in 也要慎用，否则会导致全表扫描，如： 
select id from t where num in(1,2,3)    
对于连续的数值，能用 between 就不要用 in 了：   
select id from t where num between 1 and 3  
    
6.下面的查询也将导致全表扫描：    
select id from t where name like '%abc%'    
    
7.应尽量避免在 where 子句中对字段进行表达式操作，这将导致引擎放弃使用索引而进行全表扫描。如： 
select id from t where num/2=100    
应改为:    
select id from t where num=100*2    
    
8.应尽量避免在where子句中对字段进行函数操作，这将导致引擎放弃使用索引而进行全表扫描。如：    
select id from t where substring(name,1,3)='abc'--name以abc开头的id 
应改为:    
select id from t where name like 'abc%' 
    
9.不要在 where 子句中的“=”左边进行函数、算术运算或其他表达式运算，否则系统将可能无法正确使用索引。 
    
10.在使用索引字段作为条件时，如果该索引是复合索引，那么必须使用到该索引中的第一个字段作为条件时才能保证系统使用该索引，   
否则该索引将不会被使用，并且应尽可能的让字段顺序与索引顺序相一致。   
    
11.不要写一些没有意义的查询，如需要生成一个空表结构：    
select col1,col2 into #t from t where 1=0   
这类代码不会返回任何结果集，但是会消耗系统资源的，应改成这样： 
create table #t(...)    
    
12.很多时候用 exists 代替 in 是一个好的选择：  
select num from a where num in(select num from b)   
用下面的语句替换：   
select num from a where exists(select 1 from b where num=a.num) 
    
13.并不是所有索引对查询都有效，SQL是根据表中数据来进行查询优化的，当索引列有大量数据重复时，SQL查询可能不会去利用索引，    
如一表中有字段sex，male、female几乎各一半，那么即使在sex上建了索引也对查询效率起不了作用。   
    
14.索引并不是越多越好，索引固然可以提高相应的 select 的效率，但同时也降低了 insert 及 update 的效率，    
因为 insert 或 update 时有可能会重建索引，所以怎样建索引需要慎重考虑，视具体情况而定。 
一个表的索引数最好不要超过6个，若太多则应考虑一些不常使用到的列上建的索引是否有必要。 
    
15.尽量使用数字型字段，若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并会增加存储开销。    
这是因为引擎在处理查询和连接时会逐个比较字符串中每一个字符，而对于数字型而言只需要比较一次就够了。   
    
16.尽可能的使用 varchar 代替 char ，因为首先变长字段存储空间小，可以节省存储空间，  
其次对于查询来说，在一个相对较小的字段内搜索效率显然要高些。  
    
17.任何地方都不要使用 select * from t ，用具体的字段列表代替“*”，不要返回用不到的任何字段。   
    
18.避免频繁创建和删除临时表，以减少系统表资源的消耗。
19.临时表并不是不可使用，适当地使用它们可以使某些例程更有效，例如，当需要重复引用大型表或常用表中的某个数据集时。但是，对于一次性事件，最好使用导出表。 
    
20.在新建临时表时，如果一次性插入数据量很大，那么可以使用 select into 代替 create table，避免造成大量 log ， 
以提高速度；如果数据量不大，为了缓和系统表的资源，应先create table，然后insert。
21.如果使用到了临时表，在存储过程的最后务必将所有的临时表显式删除，先 truncate table ，然后 drop table ，这样可以避免系统表的较长时间锁定。 
    
22.尽量避免使用游标，因为游标的效率较差，如果游标操作的数据超过1万行，那么就应该考虑改写。 
    
23.使用基于游标的方法或临时表方法之前，应先寻找基于集的解决方案来解决问题，基于集的方法通常更有效。
24.与临时表一样，游标并不是不可使用。对小型数据集使用 FAST_FORWARD 游标通常要优于其他逐行处理方法，尤其是在必须引用几个表才能获得所需的数据时。
在结果集中包括“合计”的例程通常要比使用游标执行的速度快。如果开发时间允许，基于游标的方法和基于集的方法都可以尝试一下，看哪一种方法的效果更好。
25.尽量避免大事务操作，提高系统并发能力。
26.尽量避免向客户端返回大数据量，若数据量过大，应该考虑相应需

使用哪种存储引擎?
出现性能瓶颈如何定位解决?
索引，SQL语句效率(切忌全表扫描)，数据迁移，水平切面等

数据定义：Create Table,Alter Table,Drop Table, Craete/Drop Index等
数据操纵：Select ,insert,update,delete,
数据控制：grant,revoke
数据查询：select


完整性约束包括哪些？
1)	数据完整性(Data Integrity)是指数据的精确(Accuracy)和可靠性(Reliability)。
2)	分为以下四类：
3)	实体完整性：规定表的每一行在表中是惟一的实体。
4)	域完整性：是指表中的列必须满足某种特定的数据类型约束，其中约束又包括取值范围、精度等规定。
5)	参照完整性：是指两个表的主关键字和外关键字的数据应一致，保证了表之间的数据的一致性，防止了数据丢失或无意义的数据在数据库中扩散。
6)	用户定义的完整性：不同的关系数据库系统根据其应用环境的不同，往往还需要一些特殊的约束条件。用户定义的完整性即是针对某个特定关系数据库的约束条件，它反映某一具体应用必须满足的语义要求。
7)	与表有关的约束：包括列约束(NOT NULL（非空约束）)和表约束(PRIMARY KEY、foreign key、check、UNIQUE) 。

什么是事务？及其特性？
事务：是一系列的数据库操作，是数据库应用的基本逻辑单位。
或这么理解：
事务就是被绑定在一起作为一个逻辑工作单元的SQL语句分组，如果任何一个语句操作失败那么整个操作就被失败，以后操作就会回滚到操作前状态，或者是上有个节点。为了确保要么执行，要么不执行，就可以使用事务。要将有组语句作为事务考虑，就需要通过ACID测试，即原子性，一致性，隔离性和持久性。

事务特性：
（1）原子性：即不可分割性，事务要么全部被执行，要么就全部不被执行。
（2）一致性或可串性。事务的执行使得数据库从一种正确状态转换成另一种正确状态
（3）隔离性。在事务正确提交之前，不允许把该事务对数据的任何改变提供给任何其他事务，
（4） 持久性。事务正确提交后，其结果将永久保存在数据库中，即使在事务提交后有了其他故障，事务的处理结果也会得到保存。
什么是锁？
8)	数据库是一个多用户使用的共享资源。当多个用户并发地存取数据时，在数据库中就会产生多个事务同时存取同一数据的情况。若对并发操作不加控制就可能会读取和存储不正确的数据，破坏数据库的一致性。
9)	加锁是实现数据库并发控制的一个非常重要的技术。当事务在对某个数据对象进行操作前，先向系统发出请求，对其加锁。加锁后事务就对该数据对象有了一定的控制，在该事务释放锁之前，其他的事务不能对此数据对象进行更新操作。
10)	基本锁类型：锁包括行级锁和表级锁

主键、外键和索引的区别？
11)	主键--唯一标识一条记录，不能有重复的，不允许为空
12)	外键--表的外键是另一表的主键, 外键可以有重复的, 可以是空值
13)	索引--该字段没有重复值，但可以有一个空值
作用：
14)	主键--用来保证数据完整性
15)	外键--用来和其他表建立联系用的
16)	索引--是提高查询排序的速度
个数：
17)	主键--主键只能有一个
18)	外键--一个表可以有多个外键
19)	索引--一个表可以有多个唯一索引

三 PHP
编程中经常采取MVC三层结构，请问MVC分别指哪三层，有什么优点？
MVC三层分别指：业务模型、视图、控制器，
由控制器层调用 模型处理数据，然后将数据映射到视图层进行显示，
优点是：①可以实现代码的重用性，避免产生代码冗余；②M和V的实现代码分离，从而使同一个程序可以使用不同的表现形式
PHP操作文件的常用函数？
打开文件；②删除文件；③读取文件；④写入文件；⑤修改文件；⑥关闭文件；⑦创建文件等等，此项非常重要，在工作中经常用来生成缓存或者静态文件，请参照php手册
PHP操作目录（文件夹）的常用函数？
①打开目录；②删除目录；③读取目录；④创建目录；⑤修改目录；⑥关闭目录等等，此项非常重要，在工作中经常用来创建或者删除上传文件的目录，创建或者删除缓存、静态页面的目录
负载均衡的原理?

